name: 'Deploy to Netlify'
description: 'Deploy built site to Netlify with URL parsing and error handling'

inputs:
  netlify-site-id:
    description: 'Netlify site ID'
    required: true
  netlify-auth-token:
    description: 'Netlify authentication token'
    required: true
  deploy-production:
    description: 'Deploy to production (true) or preview (false)'
    required: false
    default: 'false'
  deploy-alias:
    description: 'Alias for preview deployments'
    required: false
    default: 'preview'
  deploy-message:
    description: 'Deployment message'
    required: false
    default: 'Deploy from GitHub Actions'
  build-dir:
    description: 'Directory containing build output'
    required: false
    default: 'doc/build'
  init-netlify:
    description: 'Run netlify link to initialize site connection (for first-time setup)'
    required: false
    default: 'false'

outputs:
  deploy-url:
    description: 'URL of the deployed site'
    value: ${{ steps.deploy.outputs.deploy-url }}
  preview-url:
    description: 'Preview URL (if not production)'
    value: ${{ steps.deploy.outputs.preview-url }}

runs:
  using: 'composite'
  steps:
    - name: Validate inputs
      run: |
        if [ -z "${{ inputs.netlify-site-id }}" ]; then
          echo "Error: NETLIFY_SITE_ID is not set"
          exit 1
        fi
        if [ -z "${{ inputs.netlify-auth-token }}" ]; then
          echo "Error: NETLIFY_AUTH_TOKEN is not set"
          exit 1
        fi
        echo "Netlify credentials validated"
      shell: bash

    - name: Install Netlify CLI and jq
      run: |
        npm install -g netlify-cli
        # Install jq for JSON parsing (if not already available)
        if ! command -v jq &> /dev/null; then
          sudo apt-get update && sudo apt-get install -y jq
        fi
      shell: bash

    - name: Link Netlify site (init only)
      if: inputs.init-netlify == 'true'
      run: |
        echo "Linking to Netlify site..."
        # Trim whitespace from token to avoid "Invalid character in header" error
        export NETLIFY_AUTH_TOKEN=$(echo "$NETLIFY_AUTH_TOKEN_RAW" | tr -d '[:space:]')
        netlify link --id "${{ inputs.netlify-site-id }}"
        echo "Site linked successfully"
      shell: bash
      env:
        NETLIFY_AUTH_TOKEN_RAW: ${{ inputs.netlify-auth-token }}

    - name: Deploy to Netlify
      id: deploy
      run: |
        echo "Deploying to Netlify..."

        # Trim whitespace from token to avoid "Invalid character in header" error
        export NETLIFY_AUTH_TOKEN=$(echo "$NETLIFY_AUTH_TOKEN_RAW" | tr -d '[:space:]')

        # Verify build directory exists
        if [ ! -d "${{ inputs.build-dir }}" ]; then
          echo "Error: Build directory not found: ${{ inputs.build-dir }}"
          exit 1
        fi

        # Change to the doc directory to avoid monorepo "Projects detected" error
        # This ensures netlify only sees the metamodule-doc-ja package
        cd doc

        # Build deployment command based on inputs
        # Use --no-build since we're deploying a pre-built directory
        if [ "${{ inputs.deploy-production }}" = "true" ]; then
          echo "Deploying to production..."
          DEPLOY_OUTPUT=$(netlify deploy \
            --dir="build" \
            --site="${{ inputs.netlify-site-id }}" \
            --auth="$NETLIFY_AUTH_TOKEN" \
            --no-build \
            --prod \
            --json \
            --message="${{ inputs.deploy-message }}" 2>&1) || {
            echo "Deployment failed"
            echo "$DEPLOY_OUTPUT"
            exit 1
          }
        else
          echo "Deploying to preview (alias: ${{ inputs.deploy-alias }})..."
          DEPLOY_OUTPUT=$(netlify deploy \
            --dir="build" \
            --site="${{ inputs.netlify-site-id }}" \
            --auth="$NETLIFY_AUTH_TOKEN" \
            --no-build \
            --alias="${{ inputs.deploy-alias }}" \
            --json \
            --message="${{ inputs.deploy-message }}" 2>&1) || {
            echo "Deployment failed"
            echo "$DEPLOY_OUTPUT"
            exit 1
          }
        fi

        echo "$DEPLOY_OUTPUT"

        # Parse deployment URL from JSON output
        DEPLOY_URL=$(echo "$DEPLOY_OUTPUT" | jq -r '.deploy_url // empty')
        SITE_URL=$(echo "$DEPLOY_OUTPUT" | jq -r '.url // empty')

        if [ -z "$DEPLOY_URL" ]; then
          echo "Warning: Could not parse deploy_url from JSON output"
          # Fallback: try to extract URL from text output
          DEPLOY_URL=$(echo "$DEPLOY_OUTPUT" | grep -o 'https://[^ ]*netlify.app' | head -1)
        fi

        if [ -z "$DEPLOY_URL" ]; then
          echo "Error: Failed to extract deployment URL"
          exit 1
        fi

        echo "deploy-url=$DEPLOY_URL" >> $GITHUB_OUTPUT

        if [ -n "$SITE_URL" ]; then
          echo "preview-url=$SITE_URL" >> $GITHUB_OUTPUT
        fi

        echo "Deployed successfully to: $DEPLOY_URL"
      shell: bash
      env:
        NETLIFY_SITE_ID: ${{ inputs.netlify-site-id }}
        NETLIFY_AUTH_TOKEN_RAW: ${{ inputs.netlify-auth-token }}
