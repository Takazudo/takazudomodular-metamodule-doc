---
title: ファームウェアのブートプロセス
---

チップの ROM コードは `BOOT0_2` DIP スイッチを読み取り、次のいずれかを行います:

- 停止する（スイッチが `Debug` に設定されている場合）
- SD カードからブートローダーをロードしようとする（`SD` に設定されている場合）
- QSPI NOR Flash チップからブートローダーをロードしようとする（`Flash` に設定されている場合）

その後、ブートローダーの実行を開始します。

ブートローダー（`MP1-Boot`）は DDR RAM とさまざまなシステムペリフェラル（セキュリティ、MMU、クロック）を初期化します。

次に、ブートしたメディア（SD カードまたは NOR Flash）の事前指定された場所からファームウェアイメージをロードします。この場所は Linux と U-Boot でも使用されます。
その後、ファームウェアヘッダーの 1 つで指定されたエントリポイントから実行を開始します。

ただし、Freeze ジャンパーピンがグラウンドにショートされていることが検出された場合
（[PCB 画像](./firmware-debugging.md)を参照）、
ブートメディアからファームウェアをロードする前に停止します。
TAMP_BK6R レジスタに新しい値が書き込まれたことを検出するまで停止したままになります。その時点で、レジスタ内の値をアドレスとして読み取り、NOR Flash や SD カードからロードする場合と同様に、そのアドレスからファームウェアの実行を開始します。これにより、停止中に RAM の任意の場所にファームウェアイメージをロードし、その後 TAMP レジスタに場所を書き込むと、ブートローダーがファームウェアを解析、ロード、実行します。RAM へのロードは NOR Flash へのロードよりも何倍も高速なため、この方法はファームウェア開発に推奨されます。

そうでない場合（ジャンパーが検出されない場合）、ロータリーエンコーダーが押されているかどうかを確認します。
押されている場合、ブートしたメディア（SD または Flash）から代替ファームウェアイメージをロードします。すべての MetaModule には、NOR Flash チップのこのセクターに USB-DFU ブートローダーがロードされています。USB-DFU ファームウェアにより、USB 経由でファームウェアをアップグレードできます。

### セカンダリ A7 コアの起動

両方の A7 コアは同時に起動しますが、Core 2（別名セカンダリコア）はすぐにスリープ状態になります。最初のコア（プライマリ、別名 Core 1）は上記の手順を進めます。

プライマリコアが初期化されると、MetaModule ファームウェアはセカンダリコアを起こし、`firmware/lib/mdrivlib/target/stm32mp1_ca7/boot/startup_ca7.s` の `aux_core_start` アセンブリコードから実行を開始するよう指示します。このコードは基本的なスタックセットアップを行い、その後 `firmware/src/core_a7/aux_core_main.cc` の `aux_core_main()` 関数にジャンプします。ここで、セカンダリコアは画面の更新を処理し、LVGL タスクを実行します。また、オーディオ処理を支援するためにプライマリコアから割り込みを受けます。

### M4 の起動

M4 ファームウェアは main.uimg ファイル内で A7 ファームウェアとバンドルされています。シングルコアの Cortex-M4 チップとは異なり、電源投入後に M4 ファームウェアは実行されていません（M4 ファームウェアを格納する内部フラッシュがありません）。MP1-Boot ブートローダーは、M4 のファームウェア（コードとデータ）をフラッシュまたは SD カードから内部 RAM にロードする責任があります。ブートローダーが完了した後、メインアプリは A7 コアで早期初期化を行い、その後 M4 コアを起動します。

M4 ファームウェアは、すべてのコントロールとゲートジャックの読み取りを担当します。また、すべてのファイルシステム呼び出し（USB、SD カード、内部 NOR Flash）と Wi-Fi エキスパンダーも処理します。
